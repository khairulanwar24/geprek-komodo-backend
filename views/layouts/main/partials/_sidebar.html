{{ define "layouts/main/partials/_sidebar.html"}}
<!--begin::Sidebar Menu-->
<div class="app-sidebar-menu overflow-hidden flex-column-fluid">
  <div
    id="kt_app_sidebar_menu_wrapper"
    class="app-sidebar-wrapper hover-scroll-overlay-y my-5"
    data-kt-scroll="true"
    data-kt-scroll-activate="true"
    data-kt-scroll-height="auto"
    data-kt-scroll-dependencies="#kt_app_sidebar_logo, #kt_app_sidebar_footer"
    data-kt-scroll-wrappers="#kt_app_sidebar_menu"
    data-kt-scroll-offset="5px"ï¬
    data-kt-scroll-save-state="true"
  >
    <div
      class="menu menu-column menu-rounded menu-sub-indention px-3"
      id="kt_app_sidebar_menu"
      data-kt-menu="true"
      data-kt-menu-expand="false"
    >
      <!-- Static Dashboard Menu -->
      <div data-kt-menu-trigger="click" class="menu-item here show menu-accordion">
        <a href="/dashboard">
          <span class="menu-link">
            <span class="menu-icon"><i class="bi bi-grid fs-3"></i></span>
            <span class="menu-title">Dashboards</span>
          </span>
        </a>
      </div>

      <!-- Dynamic Menu Container -->
      <div id="sidebar-menu-container"></div>
    </div>
  </div>
</div>
<!--end::Sidebar Menu-->

<!-- Sidebar Menu Script -->
<script>
  async function fetchAndStoreMenu() {
    try {
      const res = await fetch("/access/menu", { credentials: "include" });
      if (!res.ok) {
        console.error("Gagal fetch menu:", res.statusText);
        return;
      }

      const result = await res.json();
      if (result.success && result.data && result.data.menu) {
        const expiry = new Date().getTime() + 10 * 60 * 1000; // 10 menit
        localStorage.setItem("menuData", JSON.stringify(result.data.menu));
        localStorage.setItem("menuDataExpiry", expiry.toString());
        renderMenu(result.data.menu);
      }
    } catch (err) {
      console.error("Error fetch menu:", err);
    }
  }

  function loadMenu() {
    const menuData = localStorage.getItem("menuData");
    const expiry = localStorage.getItem("menuDataExpiry");

    if (!menuData || !expiry || new Date().getTime() > parseInt(expiry)) {
      fetchAndStoreMenu();
    } else {
      renderMenu(JSON.parse(menuData));
    }
  }

  function renderMenu(menu) {
    const currentPath = window.location.pathname.split("/")[1]; // misal: 'master_kegiatan'
    const container = document.getElementById("sidebar-menu-container");
    container.innerHTML = ""; // reset sebelumnya

    Object.entries(menu).forEach(([menuName, items]) => {
      const menuIcon = "ki-outline ki-element-plus fs-2";

      const menuItem = document.createElement("div");
      menuItem.className = "menu-item menu-accordion";
      menuItem.setAttribute("data-kt-menu-trigger", "click");

      menuItem.innerHTML = `
        <span class="menu-link">
          <span class="menu-icon"><i class="fa ${menuIcon}"></i></span>
          <span class="menu-title">${menuName}</span>
          <span class="menu-arrow"></span>
        </span>
        <div class="menu-sub menu-sub-accordion">
          ${items
            .map(
              (item) => `
            <div class="menu-item">
              <a class="menu-link ${
                currentPath === item.modul_path ? "active" : ""
              }" href="/${item.modul_path}">
                <span class="menu-bullet">
                  <i class="fa ${item.modul_icon || "fa-circle"}"></i>
                </span>
                <span class="menu-title">${item.nama_modul}</span>
              </a>
            </div>
          `
            )
            .join("")}
        </div>
      `;

      container.appendChild(menuItem);
    });
  }

  document.addEventListener("DOMContentLoaded", loadMenu);
</script>
{{ end }}
